# pawl

An orchestrator for AI coding agents. Each agent gets its own git worktree, its own viewport, and a configurable pipeline — from branch creation to merge. You define the pipeline once, then launch as many agents as you want.

```
               ┌─ setup ─── develop ─── verify ─── merge ─── cleanup
  pawl start A ──┤
  pawl start B ──┤  Each task runs in its own worktree,
  pawl start C ──┘  isolated from the others.
```

## Why

AI coding agents (Claude, Codex, etc.) are powerful but messy to run in parallel. They conflict on files, break each other's imports, and leave merge chaos behind. Manual worktree/branch/merge management doesn't scale past 2-3 agents.

`pawl` gives each agent an isolated workspace and a structured lifecycle: setup, develop, verify, merge, clean up. The agent communicates back via `pawl done`. Everything in the pipeline is a shell command — no plugins, no SDKs.

## Install

```bash
cargo install pawl
```

Requires: Rust toolchain, tmux, git.

## Quick Start

```bash
# 1. Initialize in your project
cd your-project
pawl init

# 2. Create a task
pawl create auth-login

# 3. Write the task spec
vim .pawl/tasks/auth-login.md

# 4. Start the task
pawl start auth-login
```

## How It Works

You define a workflow in `.pawl/config.jsonc` — a list of steps that run for every task:

```jsonc
{
  "workflow": [
    { "name": "setup",   "run": "git branch ${branch} ${base_branch} 2>/dev/null; git worktree add ${worktree} ${branch}" },
    { "name": "develop", "run": "source ${repo_root}/.pawl/lib/ai-helpers.sh && cd ${worktree} && run_ai_worker",
      "in_viewport": true, "verify": "cd ${worktree} && npm test", "on_fail": "retry", "max_retries": 3 },
    { "name": "review" },
    { "name": "merge",   "run": "cd ${repo_root} && git merge --squash ${branch} && git commit -m 'feat(${task}): merge from pawl'" },
    { "name": "cleanup", "run": "git -C ${repo_root} worktree remove ${worktree} --force 2>/dev/null; git -C ${repo_root} branch -D ${branch} 2>/dev/null; true" }
  ],
  "on": { "step_completed": "echo '[pawl] ${task}/${step} exit=${exit_code}' >> ${repo_root}/.pawl/hook.log" }
}
```

### Step Types

| Type | Config | Behavior |
|------|--------|----------|
| **Command** | `{ "run": "..." }` | Runs synchronously. Fails on non-zero exit. |
| **Gate** | `{ "name": "..." }` | No `run` — pauses until `pawl done`. |
| **Agent** | `{ "run": "...", "in_viewport": true }` | Runs in viewport. Waits for `pawl done`. |
| **Verified** | `{ "run": "...", "verify": "human" }` | Runs, then waits for human approval. |

### Step Properties

| Property | Values | Description |
|----------|--------|-------------|
| `run` | shell command | Command to execute (omit for gate step) |
| `in_viewport` | `true`/`false` | Run in viewport instead of sync |
| `verify` | `"human"` or shell command | Post-step verification |
| `on_fail` | `"retry"` or `"human"` | Failure strategy |
| `max_retries` | number (default: 3) | Max auto-retries when `on_fail="retry"` |

### Variables

All `${var}` references are expanded before execution:

| Variable | Example |
|----------|---------|
| `${task}` | `auth-login` |
| `${branch}` | `pawl/auth-login` |
| `${worktree}` | `/project/.pawl/worktrees/auth-login` |
| `${session}` | `my-project` |
| `${repo_root}` | `/project` |
| `${base_branch}` | `main` |
| `${step}` | `Develop` |
| `${task_file}` | `/project/.pawl/tasks/auth-login.md` |
| `${log_file}` | `/project/.pawl/logs/auth-login.jsonl` |

## Commands

### Lifecycle

```bash
pawl init                  # Initialize .pawl/ directory
pawl create <name>         # Create a task
pawl start <task>          # Start workflow execution
```

### Flow Control

```bash
pawl done <task>           # Approve waiting step / mark in_viewport step done
pawl stop <task>           # Stop running task
pawl reset <task>          # Reset to initial state
pawl reset --step <task>   # Retry current step
```

### Monitoring

```bash
pawl status [task]         # Show status (--json for machine output)
pawl list                  # List all tasks
pawl log <task> --all      # View execution logs
pawl log <task> --step 3   # View specific step log
pawl events [task] [--follow]  # Unified event stream
pawl capture <task>        # Capture viewport content
pawl wait <task> --until completed  # Wait for status
pawl enter <task>          # Attach to viewport
```

## Task Files

Tasks are defined as markdown in `.pawl/tasks/`:

```markdown
---
name: auth-login
depends:
  - database-setup
skip:
  - cleanup
---

Implement the login API endpoint with email/password authentication.

## Requirements
- POST /api/auth/login
- Return JWT token
- Rate limit: 5 attempts per minute
```

## Project Layout

```
.pawl/
├── config.jsonc          # Workflow configuration
├── tasks/                # Task definitions (*.md)
├── logs/                 # Event logs (*.jsonl) — single source of truth
├── plans/                # Plan outputs (*.md + *.session, generated by plan-worker at runtime)
├── worktrees/            # Git worktrees (one per task)
└── lib/
    ├── ai-helpers.sh     # AI worker helper functions (plan-aware resume)
    ├── plan-worker.mjs   # SDK plan worker for plan-first workflow (Recipe 7)
    └── package.json      # Node.js deps for plan-worker (`cd .pawl/lib && npm install`)

.claude/skills/pawl/      # Claude Code skill (generated by pawl init)
└── SKILL.md              # Complete reference: config rules, recipes, foreman guide, troubleshooting
```

State is reconstructed from event logs via replay — no `status.json`.

## License

MIT
