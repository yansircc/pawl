---
name: refactor
description: 按照软件工程最佳实践分析和优化代码
---

按照软件工程最佳实践分析和优化代码：

1. **确定范围**
   - 使用 AskUserQuestion 确认：
     - 分析范围：全库 / 指定模块 / 指定文件
     - 重构深度：仅报告 / 建议 + 确认后执行

2. **分析代码库**
   - 扫描指定范围，理解模块结构和依赖关系
   - 检查以下原则（标注置信度）：
     - **SSOT**：常量、配置、类型定义是否重复
     - **DRY**：重复代码块或相似逻辑
     - **SRP**：模块/函数职责是否过多
     - **关注点分离**：层次是否清晰
     - **错误处理一致性**：unwrap/expect 使用情况

3. **生成报告（区分事实与判断）**
   - **事实**：代码位置、重复次数、依赖关系
   - **判断**：是否应重构（标注置信度：高/中/低）
   - **权衡说明**：标注可能是故意设计的情况
     - 例：性能优化导致的重复、向后兼容保留的代码
   - **风险评估**：重构可能引入的问题
     - 循环依赖、破坏性变更、测试覆盖不足

4. **交互式重构（安全优先）**
   - 用户选择要处理的问题
   - 展示重构方案，说明：
     - 变更内容
     - 潜在风险
     - 回滚方式
   - 小步执行：
     - 每次只改一处
     - 改完立即 `cargo test`
     - 失败则提示回滚

5. **边界约束**
   - 不自动执行跨模块大规模重构
   - 检测到循环依赖风险时停止并报告
   - 保留用户"跳过"和"标记为合理设计"的选项
